var oldGeoDash = window.GeoDash, GeoDash = {};

GeoDash.version = "0.1-dev", GeoDash.noConflict = function() {
    return window.GeoDash = oldGeoDash, this;
}, window.GeoDash = GeoDash, GeoDash.Chart = function(t, i) {
    this.el = t, this.options = i, this.drawChart();
}, GeoDash.Chart.prototype.drawChart = function() {}, GeoDash.Chart.prototype.update = function() {}, 
GeoDash.BarChart = function(t, i) {
    GeoDash.Chart.call(this, t, i);
}, GeoDash.BarChart.prototype = new GeoDash.Chart(), GeoDash.BarChart.prototype.constructor = GeoDash.BarChart, 
GeoDash.BarChart.prototype.drawChart = function() {
    this.margin = {
        top: 20,
        right: 20,
        bottom: 30,
        left: 40
    }, this.width = $(this.el).width() - this.margin.left - this.margin.right, this.height = $(this.el).height() - this.margin.top - this.margin.bottom, 
    this.formatPercent = d3.format(".0%"), this.x = d3.scale.ordinal().rangeRoundBands([ 0, this.width ], .05), 
    this.y = d3.scale.linear().range([ this.height, 0 ]), this.xAxis = d3.svg.axis().scale(this.x).orient("bottom").tickFormat(function() {
        return "";
    }), this.yAxis = d3.svg.axis().scale(this.y).orient("left").ticks(1).tickFormat(this.formatPercent), 
    this.svg = d3.select(this.el).append("svg").attr("width", this.width + this.margin.left + this.margin.right).attr("height", this.height + this.margin.top + this.margin.bottom).append("g").attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
}, GeoDash.BarChart.prototype.update = function(t) {
    var i = this, a = this.options.y, e = this.options.x;
    t.forEach(function(t) {
        t[a] = +t[a];
    }), this.x.domain(t.map(function(t) {
        return t[e];
    })), this.y.domain([ 0, d3.max(t, function(t) {
        return t[a];
    }) ]), this.svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(this.xAxis), 
    this.svg.append("g").attr("class", "y axis").call(this.yAxis).append("text").attr("transform", "rotate(-90)").attr("y", 6).attr("dy", ".71em").style("text-anchor", "end").text("Frequency"), 
    this.svg.selectAll(".bar").data(t).enter().append("rect").attr("class", "bar").attr("x", function(t) {
        return i.x(t[e]);
    }).attr("width", i.x.rangeBand()).attr("y", function(t) {
        return i.y(t[a]);
    }).attr("height", function(t) {
        return i.height - i.y(t[a]);
    }).style("fill", this.options.barColor);
}, GeoDash.LineChart = function(t, i) {
    GeoDash.Chart.call(this, t, i);
}, GeoDash.LineChart.prototype = new GeoDash.Chart(), GeoDash.LineChart.prototype.constructor = GeoDash.LineChart, 
GeoDash.LineChart.prototype.drawChart = function() {
    var t = this;
    this.margin = {
        top: 50,
        right: 20,
        bottom: 30,
        left: 50
    }, this.width = ("auto" === this.options.width ? $(this.el).width() : this.options.width) - this.margin.left - this.margin.right, 
    this.height = ("auto" === this.options.height ? $(this.el).height() : this.options.height) - this.margin.top - this.margin.bottom, 
    this.dotRadius = 3, this.x = d3.time.scale().range([ 0, this.width ]), this.y = d3.scale.linear().range([ this.height, 0 ]), 
    this.xAxis = d3.svg.axis().scale(this.x).tickSize(-1 * this.height).orient("bottom"), 
    this.yAxis = d3.svg.axis().scale(this.y).tickSize(-1 * this.width).orient("left"), 
    this.color = d3.scale.ordinal().range(this.options.colors), this.line = d3.svg.line().interpolate("monotone").x(function(i) {
        return t.x(i.date);
    }).y(function(i) {
        return t.y(i.value);
    }), this.formatComma = d3.format(",");
    var i = d3.select(this.el).append("svg").attr("width", this.width + this.margin.left + this.margin.right).attr("height", this.height + this.margin.top + this.margin.bottom).append("g").attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
    i.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(this.xAxis), 
    i.append("g").attr("class", "y axis").call(this.yAxis);
}, GeoDash.LineChart.prototype.hoverOnDot = function(t, i, a) {
    var e = this.formatComma(t.value), r = 55 + this.x(t.date), s = 45 + this.y(t.value);
    d3.select(a).transition().attr("r", this.dotRadius + 3);
    var n = $(".line").get(0).getBBox().width;
    this.x(t.date) >= n && (r -= 55), $(".hoverbox").css("left", r), $(".hoverbox").css("top", s), 
    $(".hoverbox").html(e), $(".hoverbox").fadeIn(200);
}, GeoDash.LineChart.prototype.hoverOffDot = function(t, i, a) {
    $(".hoverbox").fadeOut(200), d3.select(a).transition().attr("r", this.dotRadius);
}, GeoDash.LineChart.prototype.update = function(t) {
    var i = this;
    this.color.domain(d3.keys(t[0]).filter(function(t) {
        return t !== i.options.x;
    }));
    var a = this.color.domain().map(function(a) {
        return {
            name: a,
            values: t.map(function(t) {
                return {
                    date: t[i.options.x],
                    value: +t[a]
                };
            })
        };
    });
    this.x.domain(d3.extent(t, function(t) {
        return t[i.options.x];
    })), this.y.domain([ d3.min(a, function(t) {
        return d3.min(t.values, function(t) {
            return t.value;
        });
    }), d3.max(a, function(t) {
        return d3.max(t.values, function(t) {
            return t.value;
        });
    }) ]);
    var e = d3.select(this.el + " svg g");
    e.select(".y.axis").transition().call(this.yAxis), e.select(".x.axis").transition().call(this.xAxis);
    var r = function(t, i) {
        return 10 * i;
    }, s = e.selectAll(".line").data(a);
    s.transition().duration(500).delay(r).attr("d", function(t) {
        return i.line(t.values);
    }), s.enter().append("path").attr("class", "line").attr("d", function(t) {
        return i.line(t.values);
    }).style("stroke", function(t) {
        return i.color(t.name);
    });
    for (var n = 0; n < a.length; n++) {
        var o = a[n].values, h = e.selectAll(".dotset" + n).data(o);
        h.transition().duration(500).delay(r).attr("data", function(t) {
            return t.value;
        }).attr("cx", function(t) {
            return i.x(t[i.options.x]);
        }).attr("cy", function(t) {
            return i.y(t.value);
        }), h.enter().append("circle").attr("class", "dot dotset" + n).attr("r", this.dotRadius).style("fill", function() {
            return i.color(a[n].name);
        }).attr("data", function(t) {
            return t.value;
        }).on("mouseover", function(t, a) {
            i.hoverOnDot(t, a, this);
        }).on("mouseout", function(t, a) {
            i.hoverOffDot(t, a, this);
        }).attr("cx", function(t) {
            return i.x(t[i.options.x]);
        }).attr("cy", function(t) {
            return i.y(t.value);
        });
    }
};